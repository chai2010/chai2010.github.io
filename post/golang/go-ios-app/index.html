<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用Go语言开发iOS应用(Swift版) - chai2010 的博客</title>
  <link rel="alternate" hreflang="zh-CN" href="https://chai2010.cn/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="chai2010" />
  <meta name="description" content="使用Go语言开发iOS应用(Swift版) 本文加上读者对Go语言和Swift语言都有一定了解, 但是对二者混合使用不了解的同学. 本教程是基于一" />

  <meta name="keywords" content="chai2010, Go, Golang" />






<meta name="generator" content="Hugo 0.30.2" />


<link rel="canonical" href="https://chai2010.cn/post/golang/go-ios-app/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">


<meta property="og:title" content="使用Go语言开发iOS应用(Swift版)" />
<meta property="og:description" content="使用Go语言开发iOS应用(Swift版) 本文加上读者对Go语言和Swift语言都有一定了解, 但是对二者混合使用不了解的同学. 本教程是基于一" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chai2010.cn/post/golang/go-ios-app/" />



<meta property="article:published_time" content="2016-05-25T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2016-05-25T00:00:00&#43;00:00"/>











<meta itemprop="name" content="使用Go语言开发iOS应用(Swift版)">
<meta itemprop="description" content="使用Go语言开发iOS应用(Swift版) 本文加上读者对Go语言和Swift语言都有一定了解, 但是对二者混合使用不了解的同学. 本教程是基于一">


<meta itemprop="datePublished" content="2016-05-25T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-05-25T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3032">



<meta itemprop="keywords" content="golang,ios,swift,cgo," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="使用Go语言开发iOS应用(Swift版)"/>
<meta name="twitter:description" content="使用Go语言开发iOS应用(Swift版) 本文加上读者对Go语言和Swift语言都有一定了解, 但是对二者混合使用不了解的同学. 本教程是基于一"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-621845-14', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">chai2010 的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">全部文章</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/talks/">
        <li class="mobile-menu-item">报告</li>
      </a><a href="/books/">
        <li class="mobile-menu-item">图书</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">chai2010 的博客</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">全部文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/talks/">报告</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/books/">图书</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">使用Go语言开发iOS应用(Swift版)</h1>

      <div class="post-meta">
        <span class="post-time"> 2016-05-25 </span>
        <div class="post-category">
            
              <a href="/categories/golang/"> golang </a>
            
              <a href="/categories/ios/"> ios </a>
            
          </div>
        <span class="more-meta"> 约 3032 字 </span>
        <span class="more-meta"> 预计阅读 7 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#使用go语言开发ios应用-swift版">使用Go语言开发iOS应用(Swift版)</a>
<ul>
<li><a href="#背景">背景</a></li>
<li><a href="#swift调用c函数">Swift调用C函数</a></li>
<li><a href="#swift中如何管理c返回的内存">Swift中如何管理c返回的内存</a></li>
<li><a href="#go语言导出c静态库">Go语言导出C静态库</a></li>
<li><a href="#交叉构建的参数">交叉构建的参数</a></li>
<li><a href="#构建多cpu类型的静态库">构建多cpu类型的静态库</a></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="使用go语言开发ios应用-swift版">使用Go语言开发iOS应用(Swift版)</h1>

<p>本文加上读者对Go语言和Swift语言都有一定了解, 但是对二者混合使用不了解的同学.</p>

<p>本教程是基于一个真实上架的iOS应用做的简单的总结。</p>

<p>我们先看看运行效果：</p>

<p><img src="/images/go-ios-yjyy-01.png" alt="" /></p>

<h2 id="背景">背景</h2>

<p>Go语言是Google公司于2010年开源的一个面向网络服务和多并发环境的编程语言，特点是简单。
但是因为简单，也就只能实现90%的性能，这是Go语言的最大优点，因为 少即是多 的道理不是每个人都能领悟的。</p>

<p>Swift是Apple公司于2014年发布的用来替代ObjectiveC的语言，主要面向iOS和OS X上的界面程序开发。
当然用swift来开发服务器也是大家关注的一个领域，作者看好在不远的将来Swift将逐步替代C++和Rust语言。</p>

<p>Go语言和Swift语言本来是风马牛不相及的两个语言，为何非一定要整到一起呢？
原因很简单，因为作者是一个Go粉，同时也算是半个Swift粉；想试水iOS开发，但是实在是受不了ObjectiveC的裹脚布语法。</p>

<p>补充下：本人虽然不喜欢ObjectiveC的语法，但是觉得ObjectiveC的runtime还是很强悍的。
理论上，基于ObjectiveC的runtime，可以用任何流行的编程语言来开发iOS应用，RubyMotion就是一个例子。</p>

<p>其实，现在流行的绝大部分语言都有一个交集，就是c语言兼容的二进制接口。
所以说，C++流行并不是C++多厉害，而是它选择几本无缝兼容了C语言的规范。</p>

<p>但是，完全兼容C语言的规范也有缺点，就是语言本身无法自由地发展，因为很多地方会受到C语言编程模型的限制。
C++和ObjectiveC是两个比较有代表的例子。</p>

<p>所以说，Swift一出世就兼容C语言的二进制接口规范，同时抱紧了ObjectiveC的runtime大腿，而去自己确实有很大优秀的特性。</p>

<p>但是，我们这里暂时不关心Swift和ObjectiveC的混合编程，我们只关注作为ObjectiveC子集的C语言如何与Swift混合编程。</p>

<h2 id="swift调用c函数">Swift调用C函数</h2>

<p>Swift调用C函数的方法有多种：通过ObjectiveC桥接调用和直接调用。其实两者的原理是一样的，我个人跟喜欢选择最直接也最暴力的直接调用C函数的方式。</p>

<p>比如有一个C函数:</p>

<pre><code>#include &lt;stdio.h&gt;

void getInput(int *output) {
    scanf(&quot;%i&quot;, output);
}
</code></pre>

<p>生成一个桥接的头文件<code>xxx-Bridging-Header.h</code>，里面包含c函数规格说明：</p>

<pre><code>void getInput(int *output);
</code></pre>

<p>swift就可以直接使用了:</p>

<pre><code>import Foundation

var output: CInt = 0
getInput(&amp;output)

println(output)
</code></pre>

<p>如果不用桥接文件，可以在swift中声明一个Swift函数，对应C函数:</p>

<pre><code>@_silgen_name(&quot;getInput&quot;) func getInput_swift(query:UnsafePointer&lt;CInt&gt;)
</code></pre>

<p>为了明确区分C函数和swift函数，我们将<code>getInput</code>重新声明为<code>getInput_swift</code>，使用方法和前面一样：</p>

<pre><code>import Foundation

var output: CInt = 0
getInput_swift(&amp;output)

println(output)
</code></pre>

<h2 id="swift中如何管理c返回的内存">Swift中如何管理c返回的内存</h2>

<p>Swift语言本身是自带ARC的，用户很少直接关注内存问题。但是C函数如果返回内存到Swift空间，
Swift的ARC是无效的，需要手工释放C内存。</p>

<p>假设我们自己用C语言实现了一个字符串克隆的函数:</p>

<pre><code>char* MyStrDup(char* s) {
    return strdup(s);
}
</code></pre>

<p>在swift中可以这样使用：</p>

<pre><code>@_silgen_name(&quot;MyStrDup&quot;)
func MyStrDup_swift(query:UnsafePointer&lt;CChar&gt;) -&gt; UnsafeMutablePointer&lt;CChar&gt;

let p = MyStrDup_swift(&quot;hello swift-c!&quot;)
let s = String.fromCString(p)!
p.dealloc(1)
</code></pre>

<p>使用<code>String.fromCString(p)!</code>从C字符串构建一个swift字符串，然后手工调用<code>p.dealloc(1)</code>释放c字符串内存空间。</p>

<p>函数调用和内存管理是跨语言编程中最重要的两个基础问题，目前已久初步可以工作了。</p>

<h2 id="go语言导出c静态库">Go语言导出C静态库</h2>

<p>Go语言提供了一个cgo的工具，用于Go语言和C语言交互。这是Go语言使用C语言的一个例子:</p>

<pre><code>package main

//#include &lt;stdio.h&gt;
import &quot;C&quot;

func main() {
    C.puts(C.CString(&quot;abc&quot;))
}
</code></pre>

<p>既然要交互，自然会涉及到C语言回调Go语言函数的情形。为此，cgo提供了一个<code>export</code>注释命令，
用于生成Go语言函数对应的C语言函数:</p>

<pre><code>//export MyStrDup
func MyStrDup(s *C.char) *C.char {
    return C.strdup(s)
}
</code></pre>

<p><code>MyStrDup</code>指定的名字必须和Go函数名字一致，函数的参数最后是C语言支持的类型。</p>

<p>现在，我们就得到了用Go语言实现的<code>MyStrDup</code>函数，使用方法和前面的C语言实现的<code>MyStrDup</code>是一样的。</p>

<p>和引用C语言函数库遇到的问题一样，我们如何在工程中引用这些C代码或Go代码实现的函数呢？</p>

<p>答案还是来自C语言：将代码构建为C静态库或者C动态库，然后将静态库或动态库导入Swift工程。</p>

<p>但是，对于iOS来说，构建C静态库或者C动态库的过程要麻烦（使用xcode也只是隐藏了构建的具体步骤）。</p>

<p>因为，iOS涉及到多种CPU架构：模拟器的x86、4s的32位arm、5s以后的64位arm，64位arm中还有不同当版本&hellip;</p>

<p>这是C静态库或者C动态库构建始终都要面对的问题。</p>

<h2 id="交叉构建的参数">交叉构建的参数</h2>

<p>Go1.6之后增加了构建C静态库的支持，交叉编译也非常简单，只需要设置好<code>GOARCH</code>和<code>GOOS</code>就行。</p>

<p>因为，iOS的<code>GOOS</code>只有<code>Darwin</code>一种类型，我们只需要设置<code>GOARCH</code>就可以了。</p>

<p>要构建C静态库，我们需要将上面的<code>MyStrDup</code>实现放到一个<code>main</code>包中:</p>

<pre><code>package main

//#include &lt;string.h&gt;
import &quot;C&quot;

func main() {
    //
}

//export MyStrDup
func MyStrDup(s *C.char) *C.char {
    return C.strdup(s)
}
</code></pre>

<p><code>main</code>包中的<code>main</code>函数不会被执行，但是<code>init</code>函数依然有效。</p>

<p>使用下面的命令就可以构建当前系统的c静态库：</p>

<pre><code>go build -buildmode=c-archive
</code></pre>

<p>要交叉编译iOS可用的c静态库，我们需要先设置<code>GOARCH</code>，同时打开cgo特性（交叉编译时，cgo默认是关闭的）。</p>

<p>下面是构建针对模拟器的x86/amd64类型的C静态库：</p>

<pre><code>export CGO_ENABLED=1
export GOARCH=amd64

go build -buildmode=c-archive -o libmystrdup_amd64.a
</code></pre>

<p>我们使用<code>-o</code>参数指定了输出的静态库文件名。构建命令同时还会生成一个头文件（可能叫<code>libmystrdup_386.h</code>），
我们没有用到这个头文件，直接删除掉就可以。</p>

<p>下面是构建针对模拟器的x86/386类型的C静态库：</p>

<pre><code>export CGO_ENABLED=1
export GOARCH=386

go build -buildmode=c-archive -o libmystrdup_386.a
</code></pre>

<p>在构建x86/386类型的C静态库时可能会有一些link错误，我们暂时先用以下方法回避。</p>

<p>创建一个<code>patch_386.go</code>文件：</p>

<pre><code>// Copyright 2016 &lt;chaishushan{AT}gmail.com&gt;. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

// 针对iOS模拟器link时缺少的函数
// 属于临时解决方案

package main

/*
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;time.h&gt;

size_t fwrite$UNIX2003(const void* a, size_t b, size_t c, FILE* d) {
    return fwrite(a, b, c, d);
}

char* strerror$UNIX2003(int errnum) {
    return strerror(errnum);
}

time_t mktime$UNIX2003(struct tm * a) {
    return mktime(a);
}
double strtod$UNIX2003(const char * a, char ** b) {
    return strtod(a, b);
}

int setenv$UNIX2003(const char* envname, const char* envval, int overwrite) {
    return setenv(envname, envval, overwrite);
}
int unsetenv$UNIX2003(const char* name) {
    return unsetenv(name);
}

*/
import &quot;C&quot;
</code></pre>

<p>当然，还是会有一些警告出现，暂时忽略它们。</p>

<h2 id="构建多cpu类型的静态库">构建多cpu类型的静态库</h2>

<p>然后，将C静态库加入到ios的xcode工程文件就可以了。</p>

<p>x86构建是比较简单的，因为我们可以默认使用本地的构建命令。
但是，如果要构建arm的静态库，则需要先配置好构建环境。</p>

<p>我从Go代码中扣出了一个<code>clangwrap.sh</code>脚本（好像是在<code>$GOROOT/misci/ios</code>目录）:</p>

<pre><code>#!/bin/sh
# This uses the latest available iOS SDK, which is recommended.
# To select a specific SDK, run 'xcodebuild -showsdks'
# to see the available SDKs and replace iphoneos with one of them.
SDK=iphoneos
SDK_PATH=`xcrun --sdk $SDK --show-sdk-path`
export IPHONEOS_DEPLOYMENT_TARGET=7.0
# cmd/cgo doesn't support llvm-gcc-4.2, so we have to use clang.
CLANG=`xcrun --sdk $SDK --find clang`

if [ &quot;$GOARCH&quot; == &quot;arm&quot; ]; then
    CLANGARCH=&quot;armv7&quot;
elif [ &quot;$GOARCH&quot; == &quot;arm64&quot; ]; then
    CLANGARCH=&quot;arm64&quot;
else
    echo &quot;unknown GOARCH=$GOARCH&quot; &gt;&amp;2
    exit 1
fi

exec $CLANG -arch $CLANGARCH -isysroot $SDK_PATH &quot;$@&quot;
</code></pre>

<p>里面比较重要的是<code>IPHONEOS_DEPLOYMENT_TARGET</code>环境变量，这里意思是目标最低支持ios7.0系统。</p>

<p>构建arm64环境的静态库：</p>

<pre><code>export CGO_ENABLED=1
export GOARCH=arm64
export CC=$PWD/clangwrap.sh
export CXX=$PWD/clangwrap.sh

go build -buildmode=c-archive -o libmystrdup_arm64.a
</code></pre>

<p>构建armv7环境的静态库：</p>

<pre><code>export CGO_ENABLED=1
export GOARCH=arm
export GOARM=7
export CC=$PWD/clangwrap.sh
export CXX=$PWD/clangwrap.sh

go build -buildmode=c-archive -o libmystrdup_armv7.a
</code></pre>

<p>然后我们用<code>lipo</code>命令将以上这些不同的静态库打包到一个静态库中：</p>

<pre><code>lipo libmystrdup_386.a libmystrdup_adm64.a libmystrdup_arm64.a libmystrdup_armv7.a -create -output libmystrdup.a
</code></pre>

<p>这样的话，只要引入一个静态库就可以支持不同cpu类型的目标了。</p>

<h2 id="总结">总结</h2>

<p>毛主席教导我们：要在战争中学习战争。</p>

<p><strong><a href="https://appsto.re/cn/QH8ocb.i">野鸡医院</a></strong> 这个app是作者第一个iOS应用，这篇教程也是在iOS开发过程逐步学习总结的结果。</p>

<p>完整的例子：</p>

<ul>
<li>AppStore安装: <a href="https://appsto.re/cn/QH8ocb.i">https://appsto.re/cn/QH8ocb.i</a></li>
<li>Swift工程: <a href="https://github.com/chai2010/ptyy/tree/master/ios-app/yjyy-swift">https://github.com/chai2010/ptyy/tree/master/ios-app/yjyy-swift</a></li>
<li>Go静态库工程: <a href="https://github.com/chai2010/ptyy/tree/master/cmd/yjyy">https://github.com/chai2010/ptyy/tree/master/cmd/yjyy</a></li>
<li>静态库构建脚本: <a href="https://github.com/chai2010/ptyy/tree/master/ios-app/yjyy-swift/vendor/gopkg">https://github.com/chai2010/ptyy/tree/master/ios-app/yjyy-swift/vendor/gopkg</a></li>
</ul>

<p>所有的代码均可以免费获取(BSD协议): <a href="https://github.com/chai2010/ptyy">https://github.com/chai2010/ptyy</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chai2010</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2016-05-25</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/golang/">golang</a>
          
          <a href="/tags/ios/">ios</a>
          
          <a href="/tags/swift/">swift</a>
          
          <a href="/tags/cgo/">cgo</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/bazel/bazel-cpp/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Bazel C&#43;&#43; 基础[翻译]</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/bazel/bazel-ios-app/">
            <span class="next-text nav-default">Bazel教程：构建iOS应用[翻译]</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>

    <script src="https://giscus.app/client.js"
    data-repo="chai2010/chai2010.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMjQxNjY5MDk="
    data-category="General"
    data-category-id="DIC_kwDOB2ai_c4CR3mk"
    data-mapping="og:title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  

  <span class="copyright-year">
    &copy;
    
      2006 -
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">chai2010</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>


</body>
</html>
