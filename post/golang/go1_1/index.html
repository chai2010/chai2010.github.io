<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go1.1新特性介绍(语言和库更完善/性能提高约30%) - chai2010 的博客</title>
  <link rel="alternate" hreflang="zh-CN" href="https://chai2010.cn/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="chai2010" />
  <meta name="description" content="前几天GCC4.8发布, 已经部分包含Go1.1特性, 详细介绍: http://gcc.gnu.org/gcc-4.8/changes.html#go 根据golang-nuts的消息, 4月第1周可能会进入Go1.1发布流程(就" />

  <meta name="keywords" content="chai2010, Go, Golang" />






<meta name="generator" content="Hugo 0.30.2" />


<link rel="canonical" href="https://chai2010.cn/post/golang/go1_1/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">


<meta property="og:title" content="Go1.1新特性介绍(语言和库更完善/性能提高约30%)" />
<meta property="og:description" content="前几天GCC4.8发布, 已经部分包含Go1.1特性, 详细介绍: http://gcc.gnu.org/gcc-4.8/changes.html#go 根据golang-nuts的消息, 4月第1周可能会进入Go1.1发布流程(就" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chai2010.cn/post/golang/go1_1/" />



<meta property="article:published_time" content="2013-03-27T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2013-03-27T00:00:00&#43;00:00"/>











<meta itemprop="name" content="Go1.1新特性介绍(语言和库更完善/性能提高约30%)">
<meta itemprop="description" content="前几天GCC4.8发布, 已经部分包含Go1.1特性, 详细介绍: http://gcc.gnu.org/gcc-4.8/changes.html#go 根据golang-nuts的消息, 4月第1周可能会进入Go1.1发布流程(就">


<meta itemprop="datePublished" content="2013-03-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2013-03-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2927">



<meta itemprop="keywords" content="golang," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Go1.1新特性介绍(语言和库更完善/性能提高约30%)"/>
<meta name="twitter:description" content="前几天GCC4.8发布, 已经部分包含Go1.1特性, 详细介绍: http://gcc.gnu.org/gcc-4.8/changes.html#go 根据golang-nuts的消息, 4月第1周可能会进入Go1.1发布流程(就"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-621845-14', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">chai2010 的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">全部文章</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/talks/">
        <li class="mobile-menu-item">报告</li>
      </a><a href="/books/">
        <li class="mobile-menu-item">图书</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">chai2010 的博客</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">全部文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/talks/">报告</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/books/">图书</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Go1.1新特性介绍(语言和库更完善/性能提高约30%)</h1>

      <div class="post-meta">
        <span class="post-time"> 2013-03-27 </span>
        <div class="post-category">
            
              <a href="/categories/golang/"> golang </a>
            
          </div>
        <span class="more-meta"> 约 2927 字 </span>
        <span class="more-meta"> 预计阅读 6 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#语言的改变">语言的改变</a>
<ul>
<li><a href="#整数除以零是编译错误">整数除以零是编译错误</a></li>
<li><a href="#unicode代理区码点不能用于面值">Unicode代理区码点不能用于面值</a></li>
<li><a href="#方法值和方法表达式">方法值和方法表达式</a></li>
<li><a href="#return-requirements">Return requirements</a></li>
</ul></li>
<li><a href="#实现和工具的变化">实现和工具的变化</a>
<ul>
<li><a href="#gccgo的变化">gccgo的变化</a></li>
<li><a href="#命令行参数解析">命令行参数解析</a></li>
<li><a href="#64位系统-int-大小为int64">64位系统 int 大小为int64</a></li>
<li><a href="#64位平台的堆大小">64位平台的堆大小</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#race-detector">Race detector</a></li>
<li><a href="#gc-assemblers">gc assemblers</a></li>
<li><a href="#go-的变化">go 的变化</a></li>
<li><a href="#go-test-的变化">go test 的变化</a></li>
<li><a href="#go-fix-的变化">go fix 的变化</a></li>
<li><a href="#新的构建约束">新的构建约束</a></li>
<li><a href="#新支持的平台">新支持的平台</a></li>
<li><a href="#交叉编译">交叉编译</a></li>
</ul></li>
<li><a href="#性能优化">性能优化</a></li>
<li><a href="#标准库的变化">标准库的变化</a></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<!-- Go1.1有哪些改进? -->

<p>前几天GCC4.8发布, 已经部分包含Go1.1特性, 详细介绍:</p>

<ul>
<li><a href="http://gcc.gnu.org/gcc-4.8/changes.html#go">http://gcc.gnu.org/gcc-4.8/changes.html#go</a></li>
</ul>

<p>根据golang-nuts的消息, 4月第1周可能会进入Go1.1发布流程(就是下周).
要修复的问题还剩20多一点的, 估计应该不会出现大的延期.</p>

<ul>
<li><a href="http://swtch.com/~rsc/go11.html">http://swtch.com/~rsc/go11.html</a></li>
</ul>

<p>Go1.1主要的目标是性能的优化和一些bug的修复, 详细内容参考:</p>

<ul>
<li><a href="https://go.googlecode.com/hg/doc/go1.1.html">https://go.googlecode.com/hg/doc/go1.1.html</a></li>
<li><a href="http://tip.golang.org/doc/go1.1">http://tip.golang.org/doc/go1.1</a></li>
</ul>

<p>Go1.1的更新主要涉及 <strong>语言/实现/性能优化/标准库</strong> 几个部分.</p>

<p><strong>补充:</strong></p>

<ul>
<li>Go1.1正式版本已经于<strong>2013.05.14</strong>正式发布</li>
<li>Go1.1的二进制安装包将包含<a href="http://tour.golang.org/">gotour</a>程序(启动命令: <code>go tool tour</code>, 但是还有点问题).</li>
<li>gccgo1.1的发布流程和GCC4.8.1同步.</li>
<li>和C的性能对比请参考: <strong><a href="http://my.oschina.net/chai2010/blog/130859">Go1.1性能测试报告(和C差距在10%以内)</a></strong></li>
</ul>

<h1 id="语言的改变">语言的改变</h1>

<p>Go1发布时曾作出承诺, 保证在Go1.x发布后不会修改之前的语言特性. 这里有一些问题的修复, 还有一些新增加的特性.</p>

<h2 id="整数除以零是编译错误">整数除以零是编译错误</h2>

<p>在Go1中, 整数被一个常量0除会导致一个运行时 <code>panic</code>:</p>

<pre><code>func f(x int) int {
    return x/0
}
</code></pre>

<p>在 Go1.1 中, 整数被一个常量0将会被当作一个编译错误处理.</p>

<h2 id="unicode代理区码点不能用于面值">Unicode代理区码点不能用于面值</h2>

<p>字符串和 <code>rune</code> 字面值的定义更加严格. Unicode代理区码点不能用于面值. 细节请参考后面的 Unicode 章节.</p>

<h2 id="方法值和方法表达式">方法值和方法表达式</h2>

<p>Go1.1新实现了方法值(method values), 它是绑定到receiver值的一个闭包. 比如有一个实现了<code>Writer</code> 的 <code>w</code> 值, 那么 <code>w.Write</code> 将等价于下面的闭包函数:</p>

<pre><code>func (p []byte) (n int, err error) {
    return w.Write(p)
}
</code></pre>

<p>方法值(method values)不同于方法表达式(method expressions), 方法表达式是从一个类型对应的函数. 比如 <code>(*bufio.Writer).Write</code> 和下面的普通函数类型:</p>

<pre><code>func (w *bufio.Writer, p []byte) (n int, err error) {
    return w.Write(p)
}
</code></pre>

<p><em>更新:</em> 现有的代码不需要更新, 这个是新加的特性.</p>

<p>GoSpec中给出了很多例子:</p>

<pre><code>f := t.Mv; f(7)   // like t.Mv(7)
f := pt.Mp; f(7)  // like pt.Mp(7)
f := pt.Mv; f(7)  // like (*pt).Mv(7)
f := t.Mp; f(7)   // like (&amp;t).Mp(7)
f := makeT().Mp   // invalid: result of makeT() is not addressable
</code></pre>

<p>有了方法值, Go1.1可以从interface值中取出方法值(Go1.0不支持方法值):</p>

<pre><code>var i interface { M(int) } = myVal
f := i.M; f(7)  // like i.M(7)
</code></pre>

<p>这样改动的好处是类型的方法和<code>interface</code>方法完全统一了.</p>

<h2 id="return-requirements">Return requirements</h2>

<p>在Go1.1之前, 函数如果有返回值的话, 则最后必须有一个retune或panic语句.</p>

<pre><code>func abs(x int) int {
    if x &gt;= 0 {
        return x
    } else {
        return -x
    }
}
</code></pre>

<p>会有以下编译错误:</p>

<blockquote>
<p>function ends without a return statement</p>
</blockquote>

<p>之前一般可以在末尾加一个panic来回避这个问题:</p>

<pre><code>func abs(x int) int {
    if x &gt;= 0 {
        return x
    } else {
        return -x
    }
    panic(&quot;not reachable&quot;)
}
</code></pre>

<p>在Go1.1规范, 对函数的终结语句做了定义:</p>

<ul>
<li><a href="https://go.googlecode.com/hg/doc/go_spec.html#Terminating_statements">https://go.googlecode.com/hg/doc/go_spec.html#Terminating_statements</a></li>
</ul>

<p>主要有以下几种类型:</p>

<ul>
<li>return或者goto语句</li>
<li>调用内置的panic函数</li>
<li>if语句: 必须带else, 并且if和else部分都有明确的终结语句</li>
<li>for语句: 死循环的类型(无退出条件和break语句)</li>
<li>switch语句: 没有break语句, 必须有default分支, 每个分支都有终结语句(或者是fallthrough到下个分支的终结语句)</li>
<li>select语句: 无break语句, 必须有default分支, 每个分支都有终结语句</li>
<li>用于goto的Label</li>
</ul>

<p>已有的代码可以不用更新, 当然有些代码可以写的更简化.</p>

<h1 id="实现和工具的变化">实现和工具的变化</h1>

<h2 id="gccgo的变化">gccgo的变化</h2>

<p>上个月发布的 GCC 4.8.0 还没有完整的包含 Go1.1. 确实的主要功能是没有方法值, 标准库也有一些差异. 可以期望5月份发布GCC4.8.1时, gccgo能够完整支持Go1.1.</p>

<h2 id="命令行参数解析">命令行参数解析</h2>

<p>在目前的gc工具链中, 编译器和连接器使用的是同样的命令行参数解析规则, 基于Go语言的flag包实现. 和传统的UNIX命令行习惯有些不同. 这可能影响直接调用GC工具的脚本. 例如, 原有的 <code>go tool 6c -Fw -Dfoo</code> 命令, 现在要这样写 <code>go tool 6c -F -w -D foo</code>.</p>

<h2 id="64位系统-int-大小为int64">64位系统 int 大小为int64</h2>

<p>语言规范运行实现自由选择 <code>int</code> 和 <code>uint</code> 为32位或64位. 在之前的实现中, <code>int</code> 和 <code>uint</code>都是32位. 现在, 在 <code>AMD64/x86-64</code> 平台, GC和gccgo实现的<code>int</code> 和 <code>uint</code> 都是64位的. 一个相关的变化是, 在64位系统切片将可以分配超出<code>int32</code>能表示的20多亿个元素.</p>

<p><em>更新:</em> 大部分代码不受影响. 如果可能会影响涉及 <code>int</code> 类型转换有关的代码:</p>

<pre><code>x := ^uint32(0) // x is 0xffffffff
i := int(x)     // i is -1 on 32-bit systems, 0xffffffff on 64-bit
fmt.Println(i)
</code></pre>

<p>下面是一种可移植的写法(-1在所有系统是可以确定的):</p>

<pre><code>i := int(int32(x))
</code></pre>

<h2 id="64位平台的堆大小">64位平台的堆大小</h2>

<p>对于64位平台, 堆的最大上限扩大很大, 从几个GB到几十个GB(具体细节取决于系统,并且可能会更改).</p>

<p>在32位系统, 堆的大小没有变化.</p>

<p><em>更新:</em> 现有代码没有影响. 当时新程序可以使用更多的内存.</p>

<p><strong>补充:</strong> Windows/amd64目前默认为32GB(以后会根据不同版本调整).</p>

<h2 id="unicode">Unicode</h2>

<p>主要是和UTF16相关的代理区码点有关:</p>

<ul>
<li>代理区码点不能用在字符/字符串面值中.</li>
<li>代理区码点的输出也有变化</li>
</ul>

<p>比如:</p>

<pre><code>import &quot;fmt&quot;

func main() {
    fmt.Printf(&quot;%+q\n&quot;, string(0xD800))
}
</code></pre>

<p>Go 1.0输出为 &ldquo;\ud800&rdquo;, Go 1.1 输出为 &ldquo;\ufffd&rdquo;.</p>

<h2 id="race-detector">Race detector</h2>

<p><code>go tool</code>内置数据竞争检测工具. 目前只支持64位系统. 使用时需要指定<code>-race</code>选项.</p>

<p>比如以下的代码, 在2个不同goroutine中竞争访问<code>m</code>.</p>

<pre><code>func main() {
    c := make(chan bool)
    m := make(map[string]string)
    go func() {
        m[&quot;1&quot;] = &quot;a&quot; // First conflicting access.
        c &lt;- true
    }()
    m[&quot;2&quot;] = &quot;b&quot; // Second conflicting access.
    &lt;-c
    for k, v := range m {
        fmt.Println(k, v)
    }
}
</code></pre>

<p>可以这样测试:</p>

<pre><code>$ go run -race mysrc.go  // to run the source file
</code></pre>

<p><strong>补充:</strong> 检测工具目前是基于LLVM的<a href="http://llvm.org/svn/llvm-project/compiler-rt/trunk/lib/tsan/go/">ThreadSanitizer race detector</a>实现的.</p>

<h2 id="gc-assemblers">gc assemblers</h2>

<p>主要是为了适应64位系统<code>int</code>的默认大小变化, 和其他一些内部约定的变化.</p>

<h2 id="go-的变化">go 的变化</h2>

<p><code>go get</code>时必须设置<code>GOPATH</code>, 并且<code>GOPATH</code>和<code>GOROOT</code>不能相同.</p>

<p><strong>补充:</strong> 建议兲朝用户手工下载, 因为<code>go get</code>默认使用的<code>https</code>协议经常被墙.</p>

<h2 id="go-test-的变化">go test 的变化</h2>

<p>当启动了剖析选项时, <code>go test</code>默认不在删除二进制测试程序. 有专门的选项<code>-cpuprofile</code>:</p>

<pre><code>$ go test -cpuprofile cpuprof.out mypackage
</code></pre>

<p>还有<code>-blockprofile</code>选项, 可以检测goroutines被阻塞情况.</p>

<p>更多细节请参考: <code>go help test</code></p>

<h2 id="go-fix-的变化">go fix 的变化</h2>

<p>现在<code>go fix</code>将不再支持Go1之前的代码到Go1的转换. 如果需要处理Go1之前的代码, 需要先使用Go1的工具做预处理.</p>

<h2 id="新的构建约束">新的构建约束</h2>

<p>如果只在Go1.1+环境编译, 可以设置以下构建选项:</p>

<pre><code>// +build go1.1
</code></pre>

<p>如果是Go1.0.x的变化条件, 则是:</p>

<pre><code>// +build !go1.1
</code></pre>

<h2 id="新支持的平台">新支持的平台</h2>

<p>Go1.1工具链实验性的增加<code>freebsd/arm</code>, <code>netbsd/386</code>, <code>netbsd/amd64</code>, <code>netbsd/arm</code>, <code>openbsd/386</code> 和 <code>openbsd/amd64</code>平台的支持.</p>

<p>对于 <code>freebsd/arm</code> 或 <code>netbsd/arm</code> 必须是ARMv6或更高的版本.</p>

<p>Go1.1对于<code>linux/arm</code>平台实验性的提供<code>cgo</code>的支持.</p>

<h2 id="交叉编译">交叉编译</h2>

<p>交叉编译时, 默认禁止<code>CGO</code>. 如果需要启动<code>CGO</code>, 需要手工设置<code>CGO_ENABLED=1</code>.</p>

<h1 id="性能优化">性能优化</h1>

<p>主要有以下几个地方:</p>

<ul>
<li>gc编译器生成代码优化, 特别是Intel 32-bit下的浮点运算</li>
<li>gc编译器采用更多的内联优化, 比如内置的append函数和interface的转换等</li>
<li>map的一个改进实现, 显著减少内存碎片和CPU时间</li>
<li>在多核的CPU上, 可以并行的运行垃圾回收</li>
<li>更精确的垃圾回收, 可以显著减少堆的大小, 特别是在32位系统</li>
<li>运行时和网络库配合更紧密, 减少上下文切换代价</li>
<li>标准库的优化</li>
</ul>

<p>根据官方的说法, Go1.1性能提升基本有30%-40%, 有时更多(当然也有不明显的情况).</p>

<p><strong>补充:</strong> Windows版本很多优化的代码还没有合并进来, 特别是运行时/网络部分.</p>

<h1 id="标准库的变化">标准库的变化</h1>

<ul>
<li><code>reflect</code>包功能完善: 实现了<code>select</code>的支持; 类型转换支持; 变量到闭包的转换; <code>chan</code>/<code>map</code>/<code>slice</code>的支持等.</li>
<li>新加的包: <code>go/format</code>/<code>net/http/cookiejar</code>/<code>runtime/race</code></li>
<li>其他很多包的问题修复/功能完善/性能优化 等.</li>
</ul>

<p>这个部分细节太多, 具体查看官方文档吧.</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chai2010</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2013-03-27</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/golang/">golang</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/cpp/cpp-defer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">C&#43;&#43;版的defer语句</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/golang/go11-intro/">
            <span class="next-text nav-default">Go1.1有哪些改进?</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>

    <script src="https://giscus.app/client.js"
    data-repo="chai2010/chai2010.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMjQxNjY5MDk="
    data-category="General"
    data-category-id="DIC_kwDOB2ai_c4CR3mk"
    data-mapping="og:title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  

  <span class="copyright-year">
    &copy;
    
      2006 -
    2023
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">chai2010</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>


</body>
</html>
