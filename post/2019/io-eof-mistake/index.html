<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>io.EOF设计的缺陷和改进 - chai2010 的博客</title>
  <link rel="alternate" hreflang="zh-CN" href="https://chai2010.cn/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="chai2010" />
  <meta name="description" content="1. 认识io.EOF io.EOF是io包中的变量, 表示文件结束的错误: package io var EOF = errors.New(&amp;quot;EOF&amp;quot;) 也通过以下命令查看详细文档: $ go doc io.EOF var EOF = errors.New(&amp;quot;EOF&amp;quot;) EOF is the error returned by Read when" />

  <meta name="keywords" content="chai2010, Go, Golang" />






<meta name="generator" content="Hugo 0.30.2" />


<link rel="canonical" href="https://chai2010.cn/post/2019/io-eof-mistake/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">


<meta property="og:title" content="io.EOF设计的缺陷和改进" />
<meta property="og:description" content="1. 认识io.EOF io.EOF是io包中的变量, 表示文件结束的错误: package io var EOF = errors.New(&quot;EOF&quot;) 也通过以下命令查看详细文档: $ go doc io.EOF var EOF = errors.New(&quot;EOF&quot;) EOF is the error returned by Read when" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chai2010.cn/post/2019/io-eof-mistake/" />



<meta property="article:published_time" content="2019-05-14T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2019-05-14T00:00:00&#43;00:00"/>











<meta itemprop="name" content="io.EOF设计的缺陷和改进">
<meta itemprop="description" content="1. 认识io.EOF io.EOF是io包中的变量, 表示文件结束的错误: package io var EOF = errors.New(&quot;EOF&quot;) 也通过以下命令查看详细文档: $ go doc io.EOF var EOF = errors.New(&quot;EOF&quot;) EOF is the error returned by Read when">


<meta itemprop="datePublished" content="2019-05-14T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-14T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2219">



<meta itemprop="keywords" content="golang,eof," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="io.EOF设计的缺陷和改进"/>
<meta name="twitter:description" content="1. 认识io.EOF io.EOF是io包中的变量, 表示文件结束的错误: package io var EOF = errors.New(&quot;EOF&quot;) 也通过以下命令查看详细文档: $ go doc io.EOF var EOF = errors.New(&quot;EOF&quot;) EOF is the error returned by Read when"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-621845-14', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">chai2010 的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">全部文章</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/talks/">
        <li class="mobile-menu-item">报告</li>
      </a><a href="/books/">
        <li class="mobile-menu-item">图书</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">chai2010 的博客</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">全部文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/talks/">报告</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/books/">图书</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">io.EOF设计的缺陷和改进</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-05-14 </span>
        <div class="post-category">
            
              <a href="/categories/golang/"> golang </a>
            
              <a href="/categories/eof/"> eof </a>
            
          </div>
        <span class="more-meta"> 约 2219 字 </span>
        <span class="more-meta"> 预计阅读 5 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1-认识io-eof">1. 认识io.EOF</a></li>
<li><a href="#2-io-eof设计的缺陷">2. io.EOF设计的缺陷</a></li>
<li><a href="#3-io-eof改为常量">3. io.EOF改为常量</a></li>
<li><a href="#4-eof常量到error接口的隐式转换">4. EOF常量到error接口的隐式转换</a></li>
<li><a href="#5-总结">5. 总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="1-认识io-eof">1. 认识io.EOF</h2>

<p>io.EOF是io包中的变量, 表示文件结束的错误:</p>

<pre><code class="language-go">package io

var EOF = errors.New(&quot;EOF&quot;)
</code></pre>

<p>也通过以下命令查看详细文档:</p>

<pre><code>$ go doc io.EOF
var EOF = errors.New(&quot;EOF&quot;)

EOF is the error returned by Read when no more input is available. Functions
should return EOF only to signal a graceful end of input. If the EOF occurs
unexpectedly in a structured data stream, the appropriate error is either
ErrUnexpectedEOF or some other error giving more detail.
$
</code></pre>

<p>io.EOF大约可以算是Go语言中最重要的错误变量了,  它用于表示输入流的结尾. 因为每个文件都有一个结尾, 所以io.EOF很多时候并不能算是一个错误, 它更重要的是一个表示输入流结束了.</p>

<h2 id="2-io-eof设计的缺陷">2. io.EOF设计的缺陷</h2>

<p>可惜标准库中的io.EOF的设计是有问题的. 首先EOF是End-Of-File的缩写, 根据Go语言的习惯大写字母缩写一般表示常量. 可惜io.EOF被错误地定义成了变量, 这导致了API权限的扩散. 而最小化API权限是任何一个模块或函数设计的最高要求. 通过最小化的权限, 可以尽早发现代码中不必要的错误.</p>

<p>比如Go语言一个重要的安全设计就是禁止隐式的类型转换. 因此这个设计我们就可以很容易发现程序的BUG. 此外Go语言禁止定义没有被使用到的局部变量(函数参数除外, 因此函数参数是函数接口的一个部分)和禁止导入没有用到的包都是最小化权限的最佳实践. 这些最小API权限的设计不仅仅改进了程序的质量, 也提高了编译工具的性能和输出的目标文件.</p>

<p>因为EOF被定义成一个变量, 这导致了该变量可能会被恶意改变. 下面的代码就是一种优雅的埋坑方式:</p>

<pre><code class="language-go">func init() {
    io.EOF = nil
}
</code></pre>

<p>这虽然是一个段子, 但是却真实地暴漏了EOF接口的设计缺陷: 它存在严重的安全隐患. 变量的类型似乎也在暗示用户可以放心地修改变量的值. 因此说EOF是一个不安全也不优雅的设计.</p>

<h2 id="3-io-eof改为常量">3. io.EOF改为常量</h2>

<p>一个显然的改进思路是将io.EOF定义为常量. 但是因为EOF对应一个表示error接口类型, 而Go语言目前的常量语法并不支持定义常量类型的接口. 但是我们可以通过一些技巧绕过这个限制.</p>

<p>Go语言的常量有bool/int/float/string/nil这几种主要类型. 常量不仅仅不包含接口等复杂类型, 甚至连常量的数组或结构体都不支持! 不过常量有一个重要的扩展规则: 以bool/int/float/string/nil为基础类型定义的新类型也支持常量.</p>

<p>比如, 我们重新定义一个字符串类型, 它也可以支持常量的:</p>

<pre><code class="language-go">type MyString string

const name MyString = &quot;chai2010&quot;
</code></pre>

<p>这个例子中MyString是一个新定义的类型, 可以定义这种类型的常量, 因为它的底层的string类型是支持常量的.</p>

<p>那么io.EOF的底层类型是什么呢? EOF是通过errors.New(&ldquo;EOF&rdquo;)定义的, 下面是这个函数的实现:</p>

<pre><code class="language-go">package errors

// New returns an error that formats as the given text.
func New(text string) error {
    return &amp;errorString{text}
}

// errorString is a trivial implementation of error.
type errorString struct {
    s string
}

func (e *errorString) Error() string {
    return e.s
}
</code></pre>

<p>因此io.EOF底层的类型是errors.errorString结构体. 而结构体类型是不支持定义常量的. 不过errors.errorString结构体中只有一个字符串类型, io.EOF对应的错误字符串正是&rdquo;EOF&rdquo;.</p>

<p>我们可以为EOF重新实现一个以字符串为底层类型的新错误类型:</p>

<pre><code class="language-go">package io

type errorString string

func (e errorString) Error() string {
    return string(e)
}
</code></pre>

<p>这个新的io.errorString实现了两个特性: 首先是满足了error接口; 其次它是基于string类型重新定义, 因此支持定义常量. 因此我们可以基于errorString重新将io.EOF定义为常量:</p>

<pre><code class="language-go">const EOF = errorString(&quot;EOF&quot;)
</code></pre>

<p>这样EOF就变成了编译时可以确定的常量类型, 常量的值依然是“EOF”字符串. 但是也带来了新的问题: EOF已经不再是一个接口类型, 它会破坏旧代码的兼容性吗?</p>

<h2 id="4-eof常量到error接口的隐式转换">4. EOF常量到error接口的隐式转换</h2>

<p>重新将EOF从error类型的变量改定义为errorString类型的常量并不会带来兼容问题!</p>

<p>首先io.EOF虽然被定义为变量, 但是从语义角度看它其实是常量, 换言之我们只会读取这个值. 其次读取到io.EOF之后, 我们是将其作为error接口类型使用, 唯一的用处是和用户返回的错误进行相等性比较.</p>

<p>比如有以下的代码:</p>

<pre><code class="language-go">func Foo(r io.Reader) {
    var p []byte
    if _, err := r.Read(p); err != io.EOF {
        // ...
    }
}
</code></pre>

<p>这里和io.EOF进行比较的err变量必然是error类型, 或者是满足error接口的其他类型. 如果err是接口类型, 那么将io.EOF换成errorString(&ldquo;EOF&rdquo;)常量也是可以工作的:</p>

<pre><code class="language-go">func Foo(r io.Reader) {
    var p []byte
    if _, err := r.Read(p); err != errorString(&quot;EOF&quot;) {
        // ...
    }
}
</code></pre>

<p>这是因为Go语言中一个普通类型的值在和接口类型的值进行比较运算时, 会被隐式转会为接口类型(开这个后门的原因时为了方便接口代码的编写). 或则说在进行比较的时刻, errorString(&ldquo;EOF&rdquo;)已经被替换成error(errorString(&ldquo;EOF&rdquo;)).</p>

<p>普通类型到接口的隐式转会虽然方便, 但是也带来了很多坑. 比如以下的例子:</p>

<pre><code class="language-go">func Foo() error {
    var p *SomeError = nil
    return p
}
</code></pre>

<p>以上代码的nil其实是<code>*SomeError(nil)</code>. 而<code>if err != nil</code> 中的nil其实是error(nil).</p>

<p>而定义为常量的io.EOF常量在和error接口类型的值比较时, io.EOF常量会被转化为对应的接口类型. 这样新的io.EOF错误常量就可以和以前的代码无缝兼容了.</p>

<h2 id="5-总结">5. 总结</h2>

<p>普通类型到接口类型的隐式转换、常量的默认类型和基础类型是Go语言中比较隐晦的特性, 很多人虽然在使用这些规则但是并没有意识到它们的细节. 本文从分析io.EOF设计缺陷为起点, 讨论了将常量用于接口值定义的一种思路.</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chai2010</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-05-14</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/golang/">golang</a>
          
          <a href="/tags/eof/">eof</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2019/learn-string/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">谈谈Go语言字符串</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/wasm/wasm-book/">
            <span class="next-text nav-default">《WebAssembly 标准入门》开始预售了，欢迎关注!</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>

    <script src="https://giscus.app/client.js"
    data-repo="chai2010/chai2010.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMjQxNjY5MDk="
    data-category="General"
    data-category-id="DIC_kwDOB2ai_c4CR3mk"
    data-mapping="og:title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  

  <span class="copyright-year">
    &copy;
    
      2006 -
    2023
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">chai2010</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>


</body>
</html>
