## GopherChina 2018 - 上海 - 深入CGO编程 - 演讲注释

-----------------

### 致谢

感谢谢大/许大提供的平台, 能和国内Gopher当面交流.

感谢 韦光京 大牛, 为全球的 windows 平台的 Gopher 带来了 cgo 工具.

-----------------

### 个人简介 - chai2010

早期入坑的CGO用户(2010年).

目前就职于 **青云武汉**, 从事开源的 通用分布式平台 **OpenPitrix** 的开发工作.

目前Go语言已经青云的主力开发语言(以前主力语言是Python).

**CGO报告:** 2011深圳, 第一次是 入门分享; 2018上海, 第二次(可能是最后一次) 是 CGO经验 总结.

三体作者大刘表达过一个意思, 表面越简单, 内涵越丰富. *Less is more* 也是这个意思.

有以下几种组合:

- More is less - 要你命3000
- More is more - C++/Python
- Less is less - Brainfuck/Logo
- Less is more - C/Go

------------

### 快速入门

快速入门 部分 也力求以最简单的代码展示CGO的核心用法, 主要涉及三个阶段:

- 调用标准库函数, 输出 hello
- 调用自己写的C函数, 输出 hello
- 调用Go下的C函数, 输出 hello

其中涉及Go和C语言2套API和实现, 涉及3种类型的文件: `.h/.c/.go`.

------------

### 类型转换

某些教程对程序的定义: 程序 = 数据结构 + 算法.

算法对应函数, 数据结构对应C语言的类型, 类型的核心是指针.

字符串/数组都是指针, 指针本身又是一种数值, 实现不同类型的自由转换是CGO编程的首要挑战.

------------

### 函数调用

函数调用, 是大家最熟悉的概念.

关于函数调用, CGO有2个比较特别的地方:

1. 是cgo的c函数可以返回2个值, 因此void类型也可以返回值, 有了返回值就可以查看类型
2. 回调函数是CGO处理最麻烦的地方, 以函数指针的方式处理

CGO函数调用的性能开销很大

------------

### 原理和实战: 内部机制/qsort

可选内容, 根据自己兴趣私下交流

------------

### 内存模型

核心技术, 如果不了解内存模型, 将无法编写能稳定运行的并发程序(可参考我的《Go并发编程》报告).

内存模式涉及以下几个特性(针对不同问题的妥协的设计):

1. C语言固定栈, 有栈溢出风险
2. Go语言动态拷贝栈（1.4, 为何抛弃分段栈?）, 指针有移到风险
3. 面向并发的内存模型
4. 性能和简单的接口

思考题:

1. `Go -> C -> Go`, 前后2个Go函数是否是在同一个Goroutine运行?
2. `Go -> C -> Go -> C`, 如果后一个C函数长时间不返回(比如1个小时), 那么将对GC产生如何对影响?

------------

### C++对象

- 关键是要维持好Go对象的生存周期
- API的封装是C/C++领域的技巧, 不详细展开

------------

### 动态库/静态库/Py扩展/链接参数

工程问题, 根本原因还是C/C++落后的构建工具导致. windows下动态库坑更多.

py扩展可以当作实践内容.

------------

### Next: Go汇编语言

